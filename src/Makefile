# Makefile pour LibraryAPI .NET 8
# Usage: make [command]

# Variables
PROJECT_NAME = src
PROJECT_FILE = $(PROJECT_NAME).csproj
DOCKER_IMAGE = library-api
DOCKER_TAG = latest

# Couleurs pour l'affichage
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

.PHONY: help install build test clean run-dev run-prod run-railway docker ssl-dev ssl-clean migration-add migration-update migration-list migration-remove migration-script railway-login railway-deploy dev-setup ef-install ef-check ubuntu-setup dotnet-install vscode-install tools-install system-update nuget-restore nuget-update nuget-clean nuget-outdated

# Affichage de l'aide par dÃ©faut
help:
	@echo "$(GREEN)ğŸ“š LibraryAPI - Commandes disponibles$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ§ Installation Ubuntu :$(NC)"
	@echo "  make ubuntu-setup    - Installation complÃ¨te environnement Ubuntu"
	@echo "  make dotnet-install  - Installer .NET 8 SDK"
	@echo "  make vscode-install  - Installer Visual Studio Code + extensions"
	@echo "  make tools-install   - Installer tous les outils de dÃ©veloppement"
	@echo "  make system-update   - Mettre Ã  jour le systÃ¨me Ubuntu"
	@echo ""
	@echo "$(YELLOW)ğŸ› ï¸  DÃ©veloppement :$(NC)"
	@echo "  make install         - Installer les dÃ©pendances"
	@echo "  make build           - Builder le projet"
	@echo "  make test            - Lancer les tests"
	@echo "  make clean           - Nettoyer les artifacts"
	@echo "  make run-dev         - Lancer en mode dÃ©veloppement"
	@echo "  make run-prod        - Lancer en mode production"
	@echo "  make run-railway     - Lancer en mode Railway"
	@echo "  make dev-setup       - Configuration complÃ¨te dÃ©veloppement"
	@echo ""
	@echo "$(YELLOW)ğŸ”§ Entity Framework Core :$(NC)"
	@echo "  make ef-install      - Installer l'outil Entity Framework Core globalement"
	@echo "  make ef-check        - VÃ©rifier la version d'Entity Framework Core"
	@echo ""
	@echo "$(YELLOW)ğŸ“¦ Gestion des packages :$(NC)"
	@echo "  make nuget-restore   - Restaurer les packages NuGet"
	@echo "  make nuget-update    - Mettre Ã  jour les packages NuGet"
	@echo "  make nuget-clean     - Nettoyer le cache NuGet"
	@echo "  make nuget-outdated  - Lister les packages obsolÃ¨tes"
	@echo ""
	@echo "$(YELLOW)ğŸ”’ Certificats SSL :$(NC)"
	@echo "  make ssl-dev         - GÃ©nÃ©rer certificats dÃ©veloppement"
	@echo "  make ssl-clean       - Nettoyer certificats"
	@echo "  make ssl-trust       - Approuver certificats systÃ¨me"
	@echo ""
	@echo "$(YELLOW)ğŸ—„ï¸  Migrations Entity Framework :$(NC)"
	@echo "  make migration-add NAME=nom    - Ajouter migration"
	@echo "  make migration-update          - Appliquer migrations"
	@echo "  make migration-list            - Lister migrations"
	@echo "  make migration-remove          - Supprimer derniÃ¨re migration"
	@echo "  make migration-script          - GÃ©nÃ©rer script SQL"
	@echo ""
	@echo "$(YELLOW)ğŸš€ Railway :$(NC)"
	@echo "  make railway-login   - Se connecter Ã  Railway"
	@echo "  make railway-deploy  - DÃ©ployer sur Railway"
	@echo "  make railway-logs    - Voir les logs Railway"
	@echo "  make railway-vars    - Voir variables Railway"
	@echo ""
	@echo "$(YELLOW)ğŸ³ Docker :$(NC)"
	@echo "  make docker-build    - Builder image Docker"
	@echo "  make docker-run      - Lancer conteneur"
	@echo "  make docker-clean    - Nettoyer images Docker"

# Installation des dÃ©pendances
install:
	@echo "$(GREEN)ğŸ“¦ Installation des dÃ©pendances...$(NC)"
	dotnet restore $(PROJECT_FILE)
	@echo "$(GREEN)âœ… DÃ©pendances installÃ©es$(NC)"

# Build du projet
build:
	@echo "$(GREEN)ğŸ”¨ Build du projet...$(NC)"
	dotnet build $(PROJECT_FILE) --configuration Release
	@echo "$(GREEN)âœ… Build terminÃ©$(NC)"

# Tests
test:
	@echo "$(GREEN)ğŸ§ª Lancement des tests...$(NC)"
	dotnet test $(PROJECT_FILE) --logger "console;verbosity=detailed"

# Nettoyage
clean:
	@echo "$(GREEN)ğŸ§¹ Nettoyage des artifacts...$(NC)"
	dotnet clean $(PROJECT_FILE)
	rm -rf bin obj
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

# Lancement dÃ©veloppement
run-dev:
	@echo "$(GREEN)ğŸš€ Lancement en mode dÃ©veloppement...$(NC)"
	@echo "$(YELLOW)URL: http://localhost:5000 | https://localhost:5001$(NC)"
	ASPNETCORE_ENVIRONMENT=Development dotnet run --project $(PROJECT_FILE) --urls="http://localhost:5000;https://localhost:5001"

# Lancement production
run-prod:
	@echo "$(GREEN)ğŸš€ Lancement en mode production...$(NC)"
	@echo "$(YELLOW)URL: http://localhost:5000 | https://localhost:5001$(NC)"
	ASPNETCORE_ENVIRONMENT=Production dotnet run --project $(PROJECT_FILE) --urls="http://localhost:5000;https://localhost:5001"

# Lancement Railway (simulation)
run-railway:
	@echo "$(GREEN)ğŸš€ Lancement en mode Railway...$(NC)"
	@echo "$(YELLOW)URL: http://localhost:8080$(NC)"
	ASPNETCORE_ENVIRONMENT=ProductionRailway dotnet run --project $(PROJECT_FILE) --urls="http://localhost:8080"

# Configuration dÃ©veloppement complÃ¨te
dev-setup: ef-install ssl-dev install build
	@echo "$(GREEN)ğŸ‰ Environnement de dÃ©veloppement configurÃ© !$(NC)"
	@echo "$(YELLOW)Vous pouvez maintenant utiliser: make run-dev$(NC)"

# === Installation Ubuntu ===

# Installation complÃ¨te environnement Ubuntu
ubuntu-setup: system-update dotnet-install vscode-install tools-install ef-install
	@echo "$(GREEN)ğŸ‰ Installation complÃ¨te Ubuntu terminÃ©e !$(NC)"
	@echo "$(YELLOW)RedÃ©marrez votre terminal pour que tous les outils soient disponibles$(NC)"

# Mise Ã  jour du systÃ¨me Ubuntu
system-update:
	@echo "$(GREEN)ğŸ§ Mise Ã  jour du systÃ¨me Ubuntu...$(NC)"
	sudo apt update && sudo apt upgrade -y
	sudo apt install -y curl wget apt-transport-https software-properties-common
	@echo "$(GREEN)âœ… SystÃ¨me Ubuntu mis Ã  jour$(NC)"

# Installation de .NET 8 SDK
dotnet-install:
	@echo "$(GREEN)ğŸ”§ Installation de .NET 8 SDK...$(NC)"
	@if command -v dotnet >/dev/null 2>&1; then \
		echo "$(YELLOW)âš ï¸  .NET SDK dÃ©jÃ  installÃ© : $(dotnet --version)$(NC)"; \
	else \
		wget https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb -O packages-microsoft-prod.deb; \
		sudo dpkg -i packages-microsoft-prod.deb; \
		rm packages-microsoft-prod.deb; \
		sudo apt update; \
		sudo apt install -y dotnet-sdk-8.0; \
		echo "$(GREEN)âœ… .NET 8 SDK installÃ©$(NC)"; \
	fi

# Installation de Visual Studio Code + extensions
vscode-install:
	@echo "$(GREEN)ğŸ’» Installation de Visual Studio Code...$(NC)"
	@if command -v code >/dev/null 2>&1; then \
		echo "$(YELLOW)âš ï¸  Visual Studio Code dÃ©jÃ  installÃ©$(NC)"; \
	else \
		wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg; \
		sudo install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/; \
		sudo sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/trusted.gpg.d/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'; \
		sudo apt update; \
		sudo apt install -y code; \
		echo "$(GREEN)âœ… Visual Studio Code installÃ©$(NC)"; \
	fi
	@echo "$(GREEN)ğŸ”Œ Installation des extensions Visual Studio Code...$(NC)"
	code --install-extension ms-dotnettools.csharp
	code --install-extension ms-dotnettools.csdevkit
	code --install-extension ms-dotnettools.vscode-dotnet-runtime
	code --install-extension ms-vscode.vscode-json
	code --install-extension bradlc.vscode-tailwindcss
	code --install-extension esbenp.prettier-vscode
	code --install-extension ms-vscode.vscode-typescript-next
	code --install-extension formulahendry.auto-rename-tag
	code --install-extension christian-kohler.path-intellisense
	code --install-extension ms-vscode-remote.remote-containers
	code --install-extension ms-azuretools.vscode-docker
	code --install-extension humao.rest-client
	code --install-extension ms-dotnettools.dotnet-interactive-vscode
	@echo "$(GREEN)âœ… Extensions Visual Studio Code installÃ©es$(NC)"

# Installation de tous les outils de dÃ©veloppement
tools-install:
	@echo "$(GREEN)ğŸ› ï¸  Installation des outils de dÃ©veloppement...$(NC)"

	# Git
	@if ! command -v git >/dev/null 2>&1; then \
		sudo apt install -y git; \
		echo "$(GREEN)âœ… Git installÃ©$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  Git dÃ©jÃ  installÃ© : $(git --version)$(NC)"; \
	fi

	# Node.js et npm (pour outils front-end)
	@if ! command -v node >/dev/null 2>&1; then \
		curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -; \
		sudo apt install -y nodejs; \
		echo "$(GREEN)âœ… Node.js installÃ©$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  Node.js dÃ©jÃ  installÃ© : $(node --version)$(NC)"; \
	fi

	# Docker
	@if ! command -v docker >/dev/null 2>&1; then \
		sudo apt install -y ca-certificates gnupg lsb-release; \
		curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg; \
		echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null; \
		sudo apt update; \
		sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin; \
		sudo usermod -aG docker $USER; \
		echo "$(GREEN)âœ… Docker installÃ©$(NC)"; \
		echo "$(YELLOW)âš ï¸  RedÃ©marrez votre session pour utiliser Docker sans sudo$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  Docker dÃ©jÃ  installÃ© : $(docker --version)$(NC)"; \
	fi

	# MySQL Client
	@if ! command -v mysql >/dev/null 2>&1; then \
		sudo apt install -y mysql-client; \
		echo "$(GREEN)âœ… MySQL Client installÃ©$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  MySQL Client dÃ©jÃ  installÃ©$(NC)"; \
	fi

	# Postman (alternative en ligne de commande : HTTPie)
	@if ! command -v http >/dev/null 2>&1; then \
		sudo apt install -y httpie; \
		echo "$(GREEN)âœ… HTTPie installÃ©$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  HTTPie dÃ©jÃ  installÃ©$(NC)"; \
	fi

	# OpenSSL pour les certificats
	@if ! command -v openssl >/dev/null 2>&1; then \
		sudo apt install -y openssl; \
		echo "$(GREEN)âœ… OpenSSL installÃ©$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  OpenSSL dÃ©jÃ  installÃ©$(NC)"; \
	fi

	# Railway CLI
	@if ! command -v railway >/dev/null 2>&1; then \
		curl -fsSL https://railway.app/install.sh | sh; \
		echo "$(GREEN)âœ… Railway CLI installÃ©$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  Railway CLI dÃ©jÃ  installÃ©$(NC)"; \
	fi

	# Outils de build
	sudo apt install -y build-essential

	@echo "$(GREEN)âœ… Tous les outils de dÃ©veloppement installÃ©s$(NC)"

# === Gestion des packages NuGet ===

# Restaurer les packages NuGet
nuget-restore:
	@echo "$(GREEN)ğŸ“¦ Restauration des packages NuGet...$(NC)"
	dotnet restore $(PROJECT_FILE) --verbosity normal
	@echo "$(GREEN)âœ… Packages NuGet restaurÃ©s$(NC)"

# Mettre Ã  jour les packages NuGet
nuget-update:
	@echo "$(GREEN)ğŸ“¦ Mise Ã  jour des packages NuGet...$(NC)"
	dotnet list $(PROJECT_FILE) package --outdated
	@echo "$(YELLOW)Pour mettre Ã  jour un package spÃ©cifique, utilisez:$(NC)"
	@echo "$(YELLOW)  dotnet add package <PackageName>$(NC)"

# Nettoyer le cache NuGet
nuget-clean:
	@echo "$(GREEN)ğŸ§¹ Nettoyage du cache NuGet...$(NC)"
	dotnet nuget locals all --clear
	@echo "$(GREEN)âœ… Cache NuGet nettoyÃ©$(NC)"

# Lister les packages obsolÃ¨tes
nuget-outdated:
	@echo "$(GREEN)ğŸ“‹ Packages NuGet obsolÃ¨tes:$(NC)"
	dotnet list $(PROJECT_FILE) package --outdated --include-transitive

# === Gestion d'Entity Framework Core ===

# Installation d'Entity Framework Core CLI
ef-install:
	@echo "$(GREEN)ğŸ”§ Installation d'Entity Framework Core globalement...$(NC)"
	dotnet tool install --global dotnet-ef
	@echo "$(GREEN)âœ… Entity Framework Core installÃ©$(NC)"

# VÃ©rification de la version d'Entity Framework Core
ef-check:
	@echo "$(GREEN)ğŸ” VÃ©rification de la version d'Entity Framework Core...$(NC)"
	@if command -v dotnet-ef >/dev/null 2>&1; then \
		dotnet ef --version; \
		echo "$(GREEN)âœ… Entity Framework Core est installÃ©$(NC)"; \
	else \
		echo "$(RED)âŒ Entity Framework Core n'est pas installÃ©$(NC)"; \
		echo "$(YELLOW)Utilisez: make ef-install$(NC)"; \
	fi

# === Gestion des certificats SSL ===

# Nettoyage certificats
ssl-clean:
	@echo "$(GREEN)ğŸ§¹ Nettoyage des certificats...$(NC)"
	dotnet dev-certs https --clean
	rm -f localhost.pfx localhost.crt localhost.key
	@echo "$(GREEN)âœ… Certificats nettoyÃ©s$(NC)"

# GÃ©nÃ©ration certificats dÃ©veloppement
ssl-dev:
	@echo "$(GREEN)ğŸ”’ GÃ©nÃ©ration des certificats de dÃ©veloppement...$(NC)"
	@echo "$(YELLOW)MÃ©thode 1: Certificats .NET$(NC)"
	dotnet dev-certs https --clean
	dotnet dev-certs https --trust
	@echo "$(YELLOW)MÃ©thode 2: Certificats OpenSSL personnalisÃ©s$(NC)"
	@if command -v openssl >/dev/null 2>&1; then \
		openssl req -x509 -newkey rsa:4096 -keyout localhost.key -out localhost.crt -days 365 -nodes \
			-subj "/C=FR/ST=Normandy/L=Rouen/O=LibraryAPI/CN=localhost" \
			-addext "subjectAltName=DNS:localhost,IP:127.0.0.1"; \
		openssl pkcs12 -export -out localhost.pfx -inkey localhost.key -in localhost.crt -password pass:DevPassword123; \
		echo "$(GREEN)âœ… Certificats OpenSSL crÃ©Ã©s$(NC)"; \
	else \
		echo "$(RED)âŒ OpenSSL non installÃ©, utilisation des certificats .NET uniquement$(NC)"; \
	fi

# Approbation certificats systÃ¨me
ssl-trust:
	@echo "$(GREEN)ğŸ”’ Approbation des certificats systÃ¨me...$(NC)"
	@if [ -f localhost.crt ]; then \
		sudo cp localhost.crt /usr/local/share/ca-certificates/localhost-dev.crt; \
		sudo update-ca-certificates; \
		echo "$(GREEN)âœ… Certificat ajoutÃ© au systÃ¨me$(NC)"; \
	else \
		echo "$(RED)âŒ Fichier localhost.crt non trouvÃ©$(NC)"; \
	fi

# === Migrations Entity Framework ===

# VÃ©rifier Entity Framework CLI
check-ef:
	@if ! command -v dotnet-ef >/dev/null 2>&1; then \
		echo "$(YELLOW)âš ï¸  Entity Framework CLI non installÃ©, installation...$(NC)"; \
		make ef-install; \
	fi

# Ajouter migration
migration-add: check-ef
	@if [ -z "$(NAME)" ]; then \
		echo "$(RED)âŒ Usage: make migration-add NAME=NomDeLaMigration$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ“ Ajout de la migration: $(NAME)$(NC)"
	dotnet ef migrations add $(NAME) --project $(PROJECT_FILE)

# Appliquer migrations
migration-update: check-ef
	@echo "$(GREEN)ğŸ“ Application des migrations...$(NC)"
	dotnet ef database update --project $(PROJECT_FILE)
	@echo "$(GREEN)âœ… Migrations appliquÃ©es$(NC)"

# Lister migrations
migration-list: check-ef
	@echo "$(GREEN)ğŸ“ Liste des migrations:$(NC)"
	dotnet ef migrations list --project $(PROJECT_FILE)

# Supprimer derniÃ¨re migration
migration-remove: check-ef
	@echo "$(GREEN)âŒ Suppression de la derniÃ¨re migration...$(NC)"
	dotnet ef migrations remove --project $(PROJECT_FILE)

# GÃ©nÃ©rer script SQL
migration-script: check-ef
	@echo "$(GREEN)ğŸ“ GÃ©nÃ©ration du script SQL...$(NC)"
	dotnet ef migrations script --project $(PROJECT_FILE) --output migrations.sql
	@echo "$(GREEN)âœ… Script gÃ©nÃ©rÃ©: migrations.sql$(NC)"

# === Railway ===

# VÃ©rifier Railway CLI
check-railway:
	@if ! command -v railway >/dev/null 2>&1; then \
		echo "$(YELLOW)âš ï¸  Railway CLI non installÃ©, installation...$(NC)"; \
		curl -fsSL https://railway.app/install.sh | sh; \
	fi

# Connexion Railway
railway-login: check-railway
	@echo "$(GREEN)ğŸš€ Connexion Ã  Railway...$(NC)"
	railway login

# DÃ©ploiement Railway
railway-deploy: check-railway build
	@echo "$(GREEN)ğŸš€ DÃ©ploiement sur Railway...$(NC)"
	railway up

# Logs Railway
railway-logs: check-railway
	@echo "$(GREEN)ğŸ“‹ Logs Railway:$(NC)"
	railway logs

# Variables Railway
railway-vars: check-railway
	@echo "$(GREEN)ğŸ”§ Variables Railway:$(NC)"
	railway variables

# === Docker ===

# Build image Docker
docker-build:
	@echo "$(GREEN)ğŸ³ Build de l'image Docker...$(NC)"
	docker build -t $(DOCKER_IMAGE):$(DOCKER_TAG) .
	@echo "$(GREEN)âœ… Image Docker crÃ©Ã©e: $(DOCKER_IMAGE):$(DOCKER_TAG)$(NC)"

# Lancement conteneur
docker-run: docker-build
	@echo "$(GREEN)ğŸ³ Lancement du conteneur...$(NC)"
	@echo "$(YELLOW)URL: http://localhost:8080$(NC)"
	docker run -p 8080:8080 --rm --name $(PROJECT_NAME) $(DOCKER_IMAGE):$(DOCKER_TAG)

# Nettoyage Docker
docker-clean:
	@echo "$(GREEN)ğŸ§¹ Nettoyage Docker...$(NC)"
	docker rmi $(DOCKER_IMAGE):$(DOCKER_TAG) 2>/dev/null || true
	docker system prune -f

# === Utilitaires ===

# VÃ©rification santÃ© du projet
health-check:
	@echo "$(GREEN)ğŸ¥ VÃ©rification de santÃ© du projet...$(NC)"
	@echo "$(YELLOW)Version .NET:$(NC)"
	@dotnet --version
	@echo "$(YELLOW)Packages obsolÃ¨tes:$(NC)"
	@dotnet list package --outdated
	@echo "$(YELLOW)SÃ©curitÃ©:$(NC)"
	@dotnet list package --vulnerable

# Installation outils de dÃ©veloppement
install-tools: ef-install
	@echo "$(GREEN)ğŸ› ï¸  Installation des outils de dÃ©veloppement globaux...$(NC)"
	@if ! command -v dotnet-outdated >/dev/null 2>&1; then \
		dotnet tool install --global dotnet-outdated-tool; \
		echo "$(GREEN)âœ… dotnet-outdated installÃ©$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  dotnet-outdated dÃ©jÃ  installÃ©$(NC)"; \
	fi
	@echo "$(GREEN)âœ… Outils globaux installÃ©s$(NC)"

# Mise Ã  jour des packages
update-packages:
	@echo "$(GREEN)ğŸ“¦ Mise Ã  jour des packages...$(NC)"
	dotnet-outdated upgrade
	@echo "$(GREEN)âœ… Packages mis Ã  jour$(NC)"
